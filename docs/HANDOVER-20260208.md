# Handover — 2026-02-08 Session

## Summary

This session: (1) refactored the MD-to-FB tool's audit system, improved line break handling, and added input highlighting; (2) implemented the full font generator tool at `/text/font-generator`; (3) added shared text tools navigation (TextToolsNav + TextToolsDropdown); (4) switched from Inter to Satoshi font; (5) aligned font sizes across the site.

---

## Changes Made (All verified: tests pass, build clean)

### 1. Audit System — Simplified to external links only

**Rationale**: Post length, hashtags, engagement bait, allCaps checks were noisy and over-complicated the product. Only external link detection provides actionable value.

**Files changed:**

- **`src/lib/fb-audit.ts`** — Completely rewritten. Exports `hasExternalLinks(text): boolean` and `LINK_PATTERN` (global regex for URL matching). Removed `AuditFinding`, `AuditOptions`, `auditFbPost`, and all check functions (postLength, hashtags, engagementBait, allCaps).

- **`src/lib/__tests__/fb-audit.test.ts`** — Rewritten. 8 tests: `hasExternalLinks` (7) + `LINK_PATTERN` matching (1).

- **`src/components/md-to-fb/AuditPanel.tsx`** — **Deleted**. No longer needed.

- **`src/components/md-to-fb/Editor.tsx`** — External link warning moved to hint area (same row as bold hint, above editor panels). Red banner with `tAudit("externalLinks")`. Passes `highlightLinks` prop to FbPreview. Checks both `markdownInput` AND `fbOutput` for URLs (catches URLs inside backtick code that get Unicode-converted).

- **`src/components/md-to-fb/FbPreview.tsx`** — Added `highlightLinks` prop. When true, URLs in preview text are highlighted with red `<mark>`. Uses `normalizeChar()` to convert Unicode Mathematical Alphanumeric chars (Sans-Serif Bold, Italic, Monospace) back to ASCII before regex matching, then highlights original Unicode text at matched positions.

- **`messages/zh-TW.json`** — Removed: `noIssues`, `postLengthMedium`, `postLengthWithMedia`, `postLengthLong`, `hashtagsModerate`, `hashtagsTooMany`, `engagementBait`, `allCaps`, `hasMediaLabel`, `hasMediaTooltip`, `seeMore`, `fullTextBelow`. Kept: `externalLinks`.

- **`messages/en.json`** — Same removals as zh-TW.

### 2. Line Break Handling — `breaks: true`

**Rationale**: Users paste plain text with single `\n` line breaks. Markdown parser was eating them (treating consecutive lines as same paragraph). Competitor tool (tool.lifehacker.tw/space-converter) preserves line breaks.

**File changed:**

- **`src/lib/fb-renderer.ts`** — Two changes:
  1. Added `br()` renderer returning `"\n"` (preserves single line break, does NOT add blank line)
  2. Added `breaks: true` to `marked.parse()` options

**Behavior:**
- Single `\n` → preserved as line break (no extra spacing)
- `\n\n` (paragraph break) → insertZWSP adds `\u200B` → FB preserves spacing

### 3. Bold/Italic Hint — Fixed scope

**Files changed:**

- **`src/components/md-to-fb/Editor.tsx`** — `STYLED_TEXT_PATTERN` changed from `/(\*\*.+?\*\*|_.+?_|`.+?`)/` to `/(\*\*.+?\*\*|_.+?_)/`. Backtick code no longer triggers the bold hint.

- **`messages/zh-TW.json`** — `boldHint`: "粗體僅適用於英文" → "粗體與斜體僅適用於英文"
- **`messages/en.json`** — `boldHint`: "Bold works on English only" → "Bold and italic work on English only"

### 4. Markdown Input Highlighting — Backdrop overlay for unconvertible CJK

**Rationale**: When `**中文**`, `_中文_`, or `` `中文` `` appears in input, CJK chars won't be converted to Unicode bold/italic/monospace. Highlight to warn user.

**File changed:**

- **`src/components/md-to-fb/MarkdownInput.tsx`** — Added backdrop overlay technique:
  - `buildHighlight(text)` finds markdown markers containing CJK and wraps them in `<mark className="bg-amber-200/70">`
  - Backdrop `<div>` sits behind textarea (`absolute inset-0`, `text-transparent`), only `<mark>` backgrounds visible
  - `syncScroll` callback syncs textarea and backdrop scroll positions
  - Only renders backdrop when `hasUnconvertible` is true (CJK + markdown markers detected)

---

### 5. Font Generator — Full Implementation

**New files:**

| File | Description |
|------|-------------|
| `src/components/font-generator/FontGenerator.tsx` | Main tool (10 Unicode styles, CJK visual differentiation, CSS decoration preview) |
| `src/app/[locale]/text/font-generator/page.tsx` | Page entry + SEO (how-to, 5 FAQs, related tools) |
| `src/components/layout/TextToolsNav.tsx` | Shared tab bar (real `<Link>` for SEO) |
| `src/components/layout/TextToolsDropdown.tsx` | Desktop header dropdown |
| `public/fonts/satoshi-{400,500,700}.woff2` | Self-hosted Satoshi font (~75KB) |

**Modified files:**

| File | Changes |
|------|---------|
| `src/lib/unicode-fonts.ts` | 4 → 14 styles, added `convertToUnicodeRich()`, `isCjkChar()` |
| `src/components/layout/Header.tsx` | TextToolsDropdown, nav `text-sm` → `text-base` |
| `src/components/layout/MobileNav.tsx` | Added `subItems` support |
| `src/components/layout/Footer.tsx` | Copyright `text-xs` → `text-sm` |
| `src/app/[locale]/layout.tsx` | Inter → Satoshi (local) + Noto Sans TC (Google) |
| `src/app/globals.css` | Updated `--font-sans` variable |
| `src/app/[locale]/text/fb-post-formatter/page.tsx` | Added TextToolsNav, updated related tools |
| `messages/zh-TW.json` / `messages/en.json` | Added ~25 new keys (FontGenerator, TextToolsNav, Metadata, Header) |

**Key decisions:**
- CSS `text-decoration` for strikethrough/underline preview (combining chars render poorly in Satoshi)
- `convertToUnicodeRich()` enables per-char visual differentiation (unconverted CJK → `text-ink-600/30`)
- Satoshi self-hosted for brand consistency with yu-wenhao.com

---

## Current Test Status

- **142 tests passing** across 7 test files
- **Build clean** (Next.js 16, zero errors)

## Files Summary (cumulative)

| File | Status |
|------|--------|
| `src/lib/fb-audit.ts` | Rewritten (simplified) |
| `src/lib/__tests__/fb-audit.test.ts` | Rewritten |
| `src/lib/fb-renderer.ts` | Modified (breaks + br handler) |
| `src/lib/unicode-fonts.ts` | Extended (14 styles + rich conversion) |
| `src/components/md-to-fb/Editor.tsx` | Modified (audit → inline hint) |
| `src/components/md-to-fb/FbPreview.tsx` | Modified (URL highlight) |
| `src/components/md-to-fb/MarkdownInput.tsx` | Modified (backdrop overlay) |
| `src/components/md-to-fb/AuditPanel.tsx` | **Deleted** |
| `src/components/font-generator/FontGenerator.tsx` | **New** |
| `src/app/[locale]/text/font-generator/page.tsx` | **New** |
| `src/components/layout/TextToolsNav.tsx` | **New** |
| `src/components/layout/TextToolsDropdown.tsx` | **New** |
| `src/components/layout/Header.tsx` | Modified (dropdown + font sizes) |
| `src/components/layout/MobileNav.tsx` | Modified (subItems) |
| `src/components/layout/Footer.tsx` | Modified (font size) |
| `src/app/[locale]/layout.tsx` | Modified (Satoshi + Noto Sans TC) |
| `src/app/globals.css` | Modified (font-sans) |
| `public/fonts/satoshi-*.woff2` | **New** (3 files) |
| `messages/zh-TW.json` | Modified (added ~25 keys) |
| `messages/en.json` | Modified (added ~25 keys) |

## Known Issues / TODO

1. **Backdrop overlay alignment** — Not yet visually verified in browser. Font metrics (font-mono, text-sm, px-4 py-3) should match textarea exactly, but may need fine-tuning if highlight positions drift.

2. **`hasUnconvertible` check is approximate** — It checks if the entire value has BOTH markdown markers AND CJK, but doesn't verify CJK is specifically *inside* the markers. The `buildHighlight` function does the precise check. This is just a fast-path to avoid rendering the backdrop unnecessarily.

3. **No git commits made** — All changes are unstaged.

---

## Quick Start for Next Session

```bash
cd ~/GitHub/neatoolkit
npx vitest run        # 142 tests
npx next build        # clean
npm run dev           # localhost:3000 → /zh-TW/text/font-generator
```

Read this file first: `docs/HANDOVER-20260208.md`
